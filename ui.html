<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>í…ìŠ¤íŠ¸ ë²ˆì—­ê¸°1</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        font-size: 12px;
        line-height: 1.5;
        background: #f8f9fa;
        padding: 16px;
      }

      .container {
        max-width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #4f46e5;
        color: white;
        padding: 16px;
        text-align: center;
      }

      .header h1 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .header p {
        font-size: 11px;
        opacity: 0.8;
      }

      .content {
        padding: 16px;
      }

      .section {
        margin-bottom: 24px;
      }

      .section h2 {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .text-list {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        padding: 8px;
      }

      .text-item {
        padding: 6px 8px;
        margin-bottom: 4px;
        background: white;
        border-radius: 4px;
        font-size: 11px;
        color: #6b7280;
        border-left: 3px solid #e5e7eb;
        word-break: break-all;
      }

      .text-item:last-child {
        margin-bottom: 0;
      }

      .language-selector {
        margin-bottom: 16px;
      }

      .language-selector label {
        display: block;
        font-size: 11px;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
      }

      .language-selector select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #374151;
      }

      .language-selector select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }

      .button-group {
        display: flex;
        gap: 8px;
      }

      .btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #4f46e5;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #4338ca;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #e5e7eb;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 16px;
        color: #6b7280;
        font-size: 11px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #4f46e5;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .status {
        margin-top: 16px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        display: none;
      }

      .status.success {
        background: #f0f9f0;
        color: #065f46;
        border: 1px solid #a7f3d0;
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: #9ca3af;
        font-size: 11px;
      }

      .empty-state .icon {
        font-size: 24px;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>í…ìŠ¤íŠ¸ ë²ˆì—­ê¸°1234</h1>
        <p>Figma í˜ì´ì§€ì˜ í…ìŠ¤íŠ¸ë¥¼ ë‹¤ë¥¸ ì–¸ì–´ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤</p>
      </div>

      <div class="content">
        <div class="section">
          <h2>ë°œê²¬ëœ í…ìŠ¤íŠ¸</h2>
          <div id="textList" class="text-list">
            <div class="empty-state">
              <div class="icon">ğŸ“</div>
              <div>í…ìŠ¤íŠ¸ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¤‘...</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="language-selector">
            <label for="languageSelect">ë²ˆì—­í•  ì–¸ì–´ ì„ íƒ</label>
            <select id="languageSelect">
              <option value="">ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
          </div>

          <div class="button-group">
            <button id="refreshBtn" class="btn btn-secondary">
              ğŸ”„ í…ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            </button>
            <button id="translateBtn" class="btn btn-primary" disabled>
              ğŸŒ ë²ˆì—­í•˜ê¸°
            </button>
          </div>

          <div id="loading" class="loading">
            <div class="spinner"></div>
            ë²ˆì—­ ì¤‘ì…ë‹ˆë‹¤...
          </div>

          <div id="status" class="status"></div>
        </div>
      </div>
    </div>

    <script>
      console.log("=== HTML ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ===");
      console.log("window.location:", window.location.href);
      console.log("document.readyState:", document.readyState);

      // ê¸°ë³¸ DOM ì²´í¬
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ");
        const textList = document.getElementById("textList");
        console.log("textList ìš”ì†Œ:", textList);

        if (textList) {
          textList.innerHTML =
            '<div style="color: red; font-weight: bold;">ğŸ”¥ HTML ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨!</div>';
        }

        // ë²ˆì—­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const translateBtn = document.getElementById("translateBtn");
        const languageSelect = document.getElementById("languageSelect");

        if (translateBtn) {
          translateBtn.addEventListener("click", function () {
            const selectedLanguage = languageSelect.value;
            if (selectedLanguage === "") {
              alert("ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
              return;
            }
            console.log("ë²ˆì—­ ë²„íŠ¼ í´ë¦­, ì„ íƒëœ ì–¸ì–´:", selectedLanguage);
            performTranslation(selectedLanguage);
          });
        }

        // ì–¸ì–´ ì„ íƒ ë³€ê²½ ì‹œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
        if (languageSelect) {
          languageSelect.addEventListener("change", function () {
            if (translateBtn) {
              translateBtn.disabled = this.value === "";
            }
          });
        }

        // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì´ë²¤íŠ¸
        const refreshBtn = document.getElementById("refreshBtn");
        if (refreshBtn) {
          refreshBtn.addEventListener("click", function () {
            console.log("ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­");
            parent.postMessage(
              {
                pluginMessage: { type: "get-texts" },
              },
              "*"
            );
          });
        }
      });

      // ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸
      window.addEventListener("message", function (event) {
        console.log("=== HTMLì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ===", event.data);

        // ì‹¤ì œ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
        if (event.data.pluginMessage) {
          const { type, texts, languages } = event.data.pluginMessage;
          console.log(
            "âœ… ë©”ì‹œì§€ íƒ€ì…:",
            type,
            "í…ìŠ¤íŠ¸ ê°œìˆ˜:",
            texts ? texts.length : 0
          );

          if (type === "initial-texts" || type === "texts-collected") {
            console.log("ğŸ”¥ HTMLì—ì„œ ì§ì ‘ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸");
            updateTextListInHTML(texts);
            if (languages) {
              updateLanguageOptionsInHTML(languages);
            }
          } else if (type === "translation-complete") {
            console.log("ğŸ‰ ë²ˆì—­ ì™„ë£Œ!");
            alert(language + "ë¡œ ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            // ë²ˆì—­ í›„ í…ìŠ¤íŠ¸ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
            parent.postMessage(
              {
                pluginMessage: { type: "get-texts" },
              },
              "*"
            );
          }
        }
      });

      // ë²ˆì—­ í•¨ìˆ˜ (ë‚˜ì¤‘ì— OpenAIë¡œ êµì²´ ì˜ˆì •)
      function translateText(text, targetLanguage) {
        // í˜„ì¬ëŠ” ê°„ë‹¨í•˜ê²Œ ì–¸ì–´ëª…ìœ¼ë¡œ ë³€ê²½
        const languageNames = {
          ko: "í•œêµ­ì–´",
          en: "English",
          ja: "æ—¥æœ¬èª",
          zh: "ä¸­æ–‡",
          es: "EspaÃ±ol",
          fr: "FranÃ§ais",
          de: "Deutsch",
        };

        return languageNames[targetLanguage] || targetLanguage;
      }

      // HTMLì—ì„œ ì§ì ‘ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateTextListInHTML(texts) {
        console.log("ğŸ” updateTextListInHTML í˜¸ì¶œë¨, texts:", texts);

        window.currentTexts = texts; // ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥
        const textListElement = document.getElementById("textList");

        console.log("ğŸ” textListElement:", textListElement);
        console.log(
          "ğŸ” textListElement.innerHTML (before):",
          textListElement ? textListElement.innerHTML : "null"
        );

        if (!textListElement) {
          console.error("âŒ textList ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
          return;
        }

        if (!texts) {
          console.error("âŒ texts ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");
          return;
        }

        if (texts.length === 0) {
          textListElement.innerHTML = "<div>í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>";
          console.log("ğŸ” ë¹ˆ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì„¤ì •ë¨");
          return;
        }

        const textItems = texts
          .map((text, index) => {
            console.log(`ğŸ” í…ìŠ¤íŠ¸ ${index}:`, text);
            const truncated =
              text.content.length > 50
                ? text.content.substring(0, 50) + "..."
                : text.content;
            return `<div class="text-item">ğŸ“ ${truncated}</div>`;
          })
          .join("");

        console.log("ğŸ” ìƒì„±ëœ HTML:", textItems);
        textListElement.innerHTML = textItems;
        console.log(
          "ğŸ” textListElement.innerHTML (after):",
          textListElement.innerHTML
        );

        console.log(
          "ğŸ”¥ HTMLì—ì„œ DOM ì—…ë°ì´íŠ¸ ì™„ë£Œ, í…ìŠ¤íŠ¸ ê°œìˆ˜:",
          texts.length
        );
      }

      // ì–¸ì–´ ì˜µì…˜ ì—…ë°ì´íŠ¸
      function updateLanguageOptionsInHTML(languages) {
        const languageSelect = document.getElementById("languageSelect");
        if (!languageSelect || !languages) return;

        // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
        while (languageSelect.children.length > 1) {
          languageSelect.removeChild(languageSelect.lastChild);
        }

        // ìƒˆ ì–¸ì–´ ì˜µì…˜ ì¶”ê°€
        Object.entries(languages).forEach(([code, name]) => {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = name;
          languageSelect.appendChild(option);
        });

        console.log("ğŸ”¥ HTMLì—ì„œ ì–¸ì–´ ì˜µì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
      }

      // ë²ˆì—­ ì‹¤í–‰ í•¨ìˆ˜
      function performTranslation(targetLanguage) {
        if (!window.currentTexts || !targetLanguage) {
          alert("í…ìŠ¤íŠ¸ë‚˜ ì–¸ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          return;
        }

        console.log("ğŸ”„ ë²ˆì—­ ì‹œì‘:", targetLanguage);

        // í”ŒëŸ¬ê·¸ì¸ì—ê²Œ ë²ˆì—­ ìš”ì²­ ë©”ì‹œì§€ ì „ì†¡
        parent.postMessage(
          {
            pluginMessage: {
              type: "translate-texts",
              targetLanguage: targetLanguage,
            },
          },
          "*"
        );
      }

      // ë¶€ëª¨ì—ê²Œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ë³´ë‚´ê¸°
      setTimeout(function () {
        console.log("ë¶€ëª¨ì—ê²Œ í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡");
        parent.postMessage(
          {
            pluginMessage: {
              type: "ui-test-message",
            },
          },
          "*"
        );
      }, 1000);
    </script>
    <script src="dist/ui.js"></script>
  </body>
</html>
