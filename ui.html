<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>텍스트 번역기1</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        font-size: 12px;
        line-height: 1.5;
        background: #f8f9fa;
        padding: 16px;
      }

      .container {
        max-width: 100%;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: #4f46e5;
        color: white;
        padding: 16px;
        text-align: center;
      }

      .header h1 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .header p {
        font-size: 11px;
        opacity: 0.8;
      }

      .content {
        padding: 16px;
      }

      .section {
        margin-bottom: 24px;
      }

      .section h2 {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .text-list {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        padding: 8px;
      }

      .text-item {
        padding: 6px 8px;
        margin-bottom: 4px;
        background: white;
        border-radius: 4px;
        font-size: 11px;
        color: #6b7280;
        border-left: 3px solid #e5e7eb;
        word-break: break-all;
      }

      .text-item:last-child {
        margin-bottom: 0;
      }

      .language-selector {
        margin-bottom: 16px;
      }

      .language-selector label {
        display: block;
        font-size: 11px;
        color: #374151;
        margin-bottom: 4px;
        font-weight: 500;
      }

      .language-selector select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #374151;
      }

      .language-selector select:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
      }

      .button-group {
        display: flex;
        gap: 8px;
      }

      .btn {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #4f46e5;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #4338ca;
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #e5e7eb;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 16px;
        color: #6b7280;
        font-size: 11px;
      }

      .loading.show {
        display: block;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f4f6;
        border-radius: 50%;
        border-top-color: #4f46e5;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .status {
        margin-top: 16px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 11px;
        display: none;
      }

      .status.success {
        background: #f0f9f0;
        color: #065f46;
        border: 1px solid #a7f3d0;
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: #9ca3af;
        font-size: 11px;
      }

      .empty-state .icon {
        font-size: 24px;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>텍스트 번역기1234</h1>
        <p>Figma 페이지의 텍스트를 다른 언어로 번역합니다</p>
      </div>

      <div class="content">
        <div class="section">
          <h2>발견된 텍스트</h2>
          <div id="textList" class="text-list">
            <div class="empty-state">
              <div class="icon">📝</div>
              <div>텍스트를 검색하는 중...</div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="language-selector">
            <label for="languageSelect">번역할 언어 선택</label>
            <select id="languageSelect">
              <option value="">언어를 선택하세요</option>
            </select>
          </div>

          <div class="button-group">
            <button id="refreshBtn" class="btn btn-secondary">
              🔄 텍스트 새로고침
            </button>
            <button id="translateBtn" class="btn btn-primary" disabled>
              🌐 번역하기
            </button>
          </div>

          <div id="loading" class="loading">
            <div class="spinner"></div>
            번역 중입니다...
          </div>

          <div id="status" class="status"></div>
        </div>
      </div>
    </div>

    <script>
      console.log("=== HTML 인라인 스크립트 실행 ===");
      console.log("window.location:", window.location.href);
      console.log("document.readyState:", document.readyState);

      // 기본 DOM 체크
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOMContentLoaded 이벤트 발생");
        const textList = document.getElementById("textList");
        console.log("textList 요소:", textList);

        if (textList) {
          textList.innerHTML =
            '<div style="color: red; font-weight: bold;">🔥 HTML 스크립트 실행됨!</div>';
        }

        // 번역 버튼 이벤트 리스너
        const translateBtn = document.getElementById("translateBtn");
        const languageSelect = document.getElementById("languageSelect");

        if (translateBtn) {
          translateBtn.addEventListener("click", function () {
            const selectedLanguage = languageSelect.value;
            if (selectedLanguage === "") {
              alert("언어를 선택해주세요!");
              return;
            }
            console.log("번역 버튼 클릭, 선택된 언어:", selectedLanguage);
            performTranslation(selectedLanguage);
          });
        }

        // 언어 선택 변경 시 버튼 활성화/비활성화
        if (languageSelect) {
          languageSelect.addEventListener("change", function () {
            if (translateBtn) {
              translateBtn.disabled = this.value === "";
            }
          });
        }

        // 새로고침 버튼 이벤트
        const refreshBtn = document.getElementById("refreshBtn");
        if (refreshBtn) {
          refreshBtn.addEventListener("click", function () {
            console.log("새로고침 버튼 클릭");
            parent.postMessage(
              {
                pluginMessage: { type: "get-texts" },
              },
              "*"
            );
          });
        }
      });

      // 메시지 리스너 테스트
      window.addEventListener("message", function (event) {
        console.log("=== HTML에서 메시지 수신 ===", event.data);

        // 실제 텍스트 업데이트 처리
        if (event.data.pluginMessage) {
          const { type, texts, languages } = event.data.pluginMessage;
          console.log(
            "✅ 메시지 타입:",
            type,
            "텍스트 개수:",
            texts ? texts.length : 0
          );

          if (type === "initial-texts" || type === "texts-collected") {
            console.log("🔥 HTML에서 직접 텍스트 업데이트");
            updateTextListInHTML(texts);
            if (languages) {
              updateLanguageOptionsInHTML(languages);
            }
          } else if (type === "translation-complete") {
            console.log("🎉 번역 완료!");
            alert(language + "로 번역이 완료되었습니다!");
            // 번역 후 텍스트 다시 가져오기
            parent.postMessage(
              {
                pluginMessage: { type: "get-texts" },
              },
              "*"
            );
          }
        }
      });

      // 번역 함수 (나중에 OpenAI로 교체 예정)
      function translateText(text, targetLanguage) {
        // 현재는 간단하게 언어명으로 변경
        const languageNames = {
          ko: "한국어",
          en: "English",
          ja: "日本語",
          zh: "中文",
          es: "Español",
          fr: "Français",
          de: "Deutsch",
        };

        return languageNames[targetLanguage] || targetLanguage;
      }

      // HTML에서 직접 텍스트 업데이트 함수
      function updateTextListInHTML(texts) {
        console.log("🔍 updateTextListInHTML 호출됨, texts:", texts);

        window.currentTexts = texts; // 전역 변수로 저장
        const textListElement = document.getElementById("textList");

        console.log("🔍 textListElement:", textListElement);
        console.log(
          "🔍 textListElement.innerHTML (before):",
          textListElement ? textListElement.innerHTML : "null"
        );

        if (!textListElement) {
          console.error("❌ textList 요소를 찾을 수 없습니다!");
          return;
        }

        if (!texts) {
          console.error("❌ texts 데이터가 없습니다!");
          return;
        }

        if (texts.length === 0) {
          textListElement.innerHTML = "<div>텍스트가 없습니다</div>";
          console.log("🔍 빈 텍스트 메시지 설정됨");
          return;
        }

        const textItems = texts
          .map((text, index) => {
            console.log(`🔍 텍스트 ${index}:`, text);
            const truncated =
              text.content.length > 50
                ? text.content.substring(0, 50) + "..."
                : text.content;
            return `<div class="text-item">📝 ${truncated}</div>`;
          })
          .join("");

        console.log("🔍 생성된 HTML:", textItems);
        textListElement.innerHTML = textItems;
        console.log(
          "🔍 textListElement.innerHTML (after):",
          textListElement.innerHTML
        );

        console.log(
          "🔥 HTML에서 DOM 업데이트 완료, 텍스트 개수:",
          texts.length
        );
      }

      // 언어 옵션 업데이트
      function updateLanguageOptionsInHTML(languages) {
        const languageSelect = document.getElementById("languageSelect");
        if (!languageSelect || !languages) return;

        // 기존 옵션 제거 (첫 번째 기본 옵션 제외)
        while (languageSelect.children.length > 1) {
          languageSelect.removeChild(languageSelect.lastChild);
        }

        // 새 언어 옵션 추가
        Object.entries(languages).forEach(([code, name]) => {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = name;
          languageSelect.appendChild(option);
        });

        console.log("🔥 HTML에서 언어 옵션 업데이트 완료");
      }

      // 번역 실행 함수
      function performTranslation(targetLanguage) {
        if (!window.currentTexts || !targetLanguage) {
          alert("텍스트나 언어가 선택되지 않았습니다.");
          return;
        }

        console.log("🔄 번역 시작:", targetLanguage);

        // 플러그인에게 번역 요청 메시지 전송
        parent.postMessage(
          {
            pluginMessage: {
              type: "translate-texts",
              targetLanguage: targetLanguage,
            },
          },
          "*"
        );
      }

      // 부모에게 테스트 메시지 보내기
      setTimeout(function () {
        console.log("부모에게 테스트 메시지 전송");
        parent.postMessage(
          {
            pluginMessage: {
              type: "ui-test-message",
            },
          },
          "*"
        );
      }, 1000);
    </script>
    <script src="dist/ui.js"></script>
  </body>
</html>
